<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEXUS OMEGA v14.2 - Auto Fallback</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script type="importmap">
    {
        "imports": {
            "@mlc-ai/web-llm": "https://esm.run/@mlc-ai/web-llm",
            "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
    }
    </script>

    <style>
        :root {
            --bg-body: #050505;
            --bg-panel: #0a0a0c;
            --border: #333;
            --primary: #00f3ff;
            --accent: #00ff9d;
            --purple: #bc13fe;
            --gold: #ffd700;
            --danger: #ff0055;
            --text-main: #f4f4f5;
            --font-mono: 'Courier New', monospace;
            --font-main: 'Segoe UI', system-ui, sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: var(--font-main);
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 300px;
            background: #000;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 10px;
            gap: 10px;
            z-index: 20;
            overflow-y: auto;
        }

        h1 { font-size: 1.1rem; color: var(--primary); text-align: center; margin: 10px 0; letter-spacing: 2px; }

        details {
            background: #0f0f0f;
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
            transition: 0.3s;
        }
        details[open] { border-color: #555; }
        
        summary {
            padding: 10px; cursor: pointer; font-weight: bold; font-size: 0.8rem; color: #ccc;
            background: #151515; list-style: none; display: flex; justify-content: space-between;
        }
        .panel-content { padding: 10px; display: flex; flex-direction: column; gap: 8px; }

        label { font-size: 0.7rem; color: #888; font-weight: bold; text-transform: uppercase; }
        input, select {
            width: 100%; background: #000; border: 1px solid #333; color: #fff;
            padding: 8px; border-radius: 4px; font-family: var(--font-mono); font-size: 0.8rem; outline: none;
        }
        button {
            width: 100%; padding: 8px; border-radius: 4px; font-weight: bold; cursor: pointer;
            border: 1px solid; background: #111; color: #aaa; text-transform: uppercase; font-size: 0.75rem;
        }
        button:hover:not(:disabled) { background: #222; color: #fff; }
        .btn-load { border-color: var(--accent); color: var(--accent); }
        .btn-save { border-color: var(--primary); color: var(--primary); }

        /* --- MAIN AREA --- */
        .main-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background: radial-gradient(circle at 50% 30%, #111 0%, #000 100%);
        }

        #chat-container {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message { max-width: 90%; padding: 10px 15px; border-radius: 6px; font-size: 0.95rem; line-height: 1.5; border-left: 3px solid #555; background: #111; animation: fadeIn 0.2s; }
        .message.user { align-self: flex-end; border-left: none; border-right: 3px solid #fff; background: #1a1a1a; text-align: right; }
        .message.system { align-self: center; border: none; background: transparent; color: #666; font-style: italic; text-align: center; font-size: 0.8rem;}
        
        .header { font-size: 0.7rem; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; }
        
        /* Colores Header */
        .header-gemini { color: var(--primary); }
        .header-groq { color: var(--purple); }
        .header-local { color: var(--accent); }
        .header-error { color: var(--danger); }

        /* --- ACTION BAR --- */
        .action-bar {
            background: #0e0e0e;
            border-top: 1px solid var(--border);
            padding: 10px 20px;
            display: flex; gap: 15px; align-items: center; flex-wrap: wrap;
        }
        .control-group { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: #aaa; }
        .btn-stop { border-color: var(--danger); color: var(--danger); width: auto; padding: 5px 15px; }

        /* INPUT */
        .input-wrapper {
            padding: 0 20px 20px 20px;
            background: #0e0e0e;
            display: flex; gap: 10px;
        }
        textarea {
            flex-grow: 1; background: #050505; border: 1px solid #333; border-radius: 4px;
            padding: 12px; color: #fff; font-family: var(--font-main); font-size: 1rem;
            resize: none; height: 50px; outline: none;
        }
        .btn-send { width: 60px; height: 50px; background: var(--primary); color: #000; font-size: 1.5rem; border: none; }

        #progress-bar { height: 3px; width: 0%; background: var(--accent); transition: 0.2s; margin-top: 5px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="sidebar">
        <h1>NEXUS Œ© <span style="font-size:0.5em">v14.2</span></h1>

        <details open>
            <summary>üè† MOTOR LOCAL (GPU)</summary>
            <div class="panel-content">
                <select id="model-select">
                    <option value="Llama-3.2-1B-Instruct-q4f16_1-MLC">Llama 3.2 1B (R√°pido)</option>
                    <option value="TinyLlama-1.1B-Chat-v1.0-q4f16_1-MLC">TinyLlama (Ligero)</option>
                    <option value="Phi-3-mini-4k-instruct-q4f16_1-MLC">Phi-3 Mini (Potente)</option>
                </select>
                <button id="btn-load" class="btn-load" onclick="app.loadLocalEngine()">‚ö° Cargar Motor</button>
                <div id="engine-status" style="font-size:0.7em; color:#666;">Offline</div>
                <div style="background:#222; height:3px;"><div id="progress-bar"></div></div>
            </div>
        </details>

        <details open>
            <summary>‚òÅÔ∏è APIS (RESPALDO)</summary>
            <div class="panel-content">
                <label>Google Gemini:</label>
                <input type="password" id="api-gemini" placeholder="AIza...">
                <label>Groq (Llama Cloud):</label>
                <input type="password" id="api-groq" placeholder="gsk_...">
                <button class="btn-save" onclick="app.saveKeys()">üíæ Guardar Claves</button>
            </div>
        </details>
    </div>

    <div class="main-area">
        <div id="chat-container">
            <div class="message system">
                SISTEMA DE RESPALDO AUTOM√ÅTICO ACTIVO.<br>
                Intentar√©: <strong>1. Gemini ‚ûî 2. Groq ‚ûî 3. Local</strong><br>
                Si uno falla, uso el siguiente autom√°ticamente.
            </div>
        </div>

        <div class="action-bar">
            <div class="control-group">
                <label>Prioridad:</label>
                <select id="engine-priority" style="width:auto;">
                    <option value="auto">ü§ñ Inteligente (Auto-Fallback)</option>
                    <option value="local">üè† Solo Local</option>
                    <option value="cloud">‚òÅÔ∏è Solo Nube</option>
                </select>
            </div>
            <button class="btn-stop" onclick="app.stopGeneration()">üõë PARAR</button>
        </div>

        <div class="input-wrapper">
            <textarea id="user-input" placeholder="Escribe tu instrucci√≥n..."></textarea>
            <button class="btn-send" onclick="app.process()">‚û§</button>
        </div>
    </div>

    <script type="module">
        import { CreateMLCEngine } from "https://esm.run/@mlc-ai/web-llm";
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        marked.setOptions({ highlight: (code, lang) => hljs.highlightAuto(code).value });

        class NexusOmega {
            constructor() {
                this.localEngine = null;
                this.keys = { gemini: '', groq: '' };
                this.abortController = null;
                this.isProcessing = false;
                
                this.ui = {
                    chat: document.getElementById('chat-container'),
                    input: document.getElementById('user-input'),
                    status: document.getElementById('engine-status'),
                    bar: document.getElementById('progress-bar'),
                    btnLoad: document.getElementById('btn-load'),
                    priority: document.getElementById('engine-priority')
                };

                this.init();
            }

            init() {
                this.loadKeys();
                this.ui.input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.process(); }
                });
            }

            saveKeys() {
                this.keys.gemini = document.getElementById('api-gemini').value.trim();
                this.keys.groq = document.getElementById('api-groq').value.trim();
                localStorage.setItem('nexus_keys_v14', JSON.stringify(this.keys));
                alert("Claves guardadas.");
            }

            loadKeys() {
                const saved = localStorage.getItem('nexus_keys_v14');
                if (saved) {
                    this.keys = JSON.parse(saved);
                    document.getElementById('api-gemini').value = this.keys.gemini;
                    document.getElementById('api-groq').value = this.keys.groq;
                }
            }

            async loadLocalEngine() {
                const modelId = document.getElementById('model-select').value;
                this.ui.btnLoad.disabled = true;
                this.ui.status.innerText = "Cargando GPU...";

                try {
                    this.localEngine = await CreateMLCEngine(modelId, {
                        initProgressCallback: (rep) => {
                            this.ui.bar.style.width = `${rep.progress * 100}%`;
                            this.ui.status.innerText = rep.text;
                        }
                    });
                    this.ui.status.innerText = "üü¢ Online";
                    this.ui.btnLoad.innerText = "Activo";
                    this.addMsg("system", "Motor Local listo para el respaldo.");
                } catch (e) {
                    this.ui.status.innerText = "Error";
                    alert(e.message);
                    this.ui.btnLoad.disabled = false;
                }
            }

            stopGeneration() {
                if (this.abortController) {
                    this.abortController.abort();
                    this.abortController = null;
                    this.isProcessing = false;
                    this.addMsg("system", "üõë Detenido.");
                }
            }

            async process() {
                const text = this.ui.input.value.trim();
                if (!text || this.isProcessing) return;

                this.ui.input.value = "";
                this.isProcessing = true;
                this.abortController = new AbortController();
                this.addMsg("user", text);

                const priority = this.ui.priority.value;

                try {
                    let success = false;

                    // 1. INTENTO CON GEMINI (Si est√° configurado y prioridad es Auto o Cloud)
                    if (!success && (priority === 'auto' || priority === 'cloud') && this.keys.gemini) {
                        try {
                            await this.runGemini(text);
                            success = true;
                        } catch (e) {
                            this.addMsg("system", `‚ö†Ô∏è Error Gemini: ${e.message}. Cambiando a Groq...`, "header-error");
                        }
                    }

                    // 2. INTENTO CON GROQ (Si Gemini fall√≥ o no est√°, y hay clave)
                    if (!success && (priority === 'auto' || priority === 'cloud') && this.keys.groq) {
                        try {
                            await this.runGroq(text);
                            success = true;
                        } catch (e) {
                            this.addMsg("system", `‚ö†Ô∏è Error Groq: ${e.message}. Cambiando a Local...`, "header-error");
                        }
                    }

                    // 3. INTENTO CON LOCAL (Si todo lo dem√°s fall√≥)
                    if (!success && (priority === 'auto' || priority === 'local')) {
                        if (this.localEngine) {
                            await this.runLocal(text);
                            success = true;
                        } else {
                            throw new Error("No hay motores disponibles. Carga el motor local o revisa tus API Keys.");
                        }
                    }

                    if (!success) throw new Error("Todos los intentos fallaron.");

                } catch (e) {
                    if (e.name !== 'AbortError') this.addMsg("system", "‚ùå Error Fatal: " + e.message);
                } finally {
                    this.isProcessing = false;
                }
            }

            // --- MOTORES ---

            async runGemini(text) {
                const genAI = new GoogleGenerativeAI(this.keys.gemini);
                // Usamos el modelo m√°s reciente para evitar errores 404 de versiones viejas
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash-latest" });
                
                const result = await model.generateContent(text);
                const response = result.response.text();
                this.addMsg("Gemini (Nube)", response, "header-gemini");
            }

            async runGroq(text) {
                const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${this.keys.groq}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ model: "llama3-70b-8192", messages: [{role:"user", content:text}] })
                });
                
                if (!resp.ok) throw new Error(`API Error ${resp.status}`);
                
                const data = await resp.json();
                this.addMsg("Groq (Nube)", data.choices[0].message.content, "header-groq");
            }

            async runLocal(text) {
                const chunks = await this.localEngine.chat.completions.create({
                    messages: [{ role: "user", content: text }]
                });
                this.addMsg("Local (GPU)", chunks.choices[0].message.content, "header-local");
            }

            // --- UI UTILS ---
            addMsg(role, text, headerClass) {
                const div = document.createElement('div');
                div.className = `message ${role === 'user' ? 'user' : 'system'}`;
                
                if (role !== 'user' && role !== 'system') { // Es un mensaje de IA
                    div.className = 'message'; // Clase base
                    div.innerHTML = `
                        <div class="header" style="${this.getHeaderColor(headerClass)}">${role}</div>
                        <div class="content markdown-body">${marked.parse(text)}</div>
                    `;
                } else {
                    div.innerHTML = marked.parse(text);
                }
                
                this.ui.chat.appendChild(div);
                this.ui.chat.scrollTop = this.ui.chat.scrollHeight;
                div.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
            }

            getHeaderColor(cls) {
                if (cls === 'header-gemini') return 'color:var(--primary)';
                if (cls === 'header-groq') return 'color:var(--purple)';
                if (cls === 'header-local') return 'color:var(--accent)';
                return 'color:#aaa';
            }
        }

        window.app = new NexusOmega();
    </script>
</body>
</html>
