<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS INFINITY v17.2 - Sequential Chain (Corregido)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/speak-tts@4.3.2/dist/speak-tts.min.js"></script>
    
    <script type="importmap">
    {
        "imports": {
            "@mlc-ai/web-llm": "https://esm.run/@mlc-ai/web-llm@0.2.46",
            "@google/generative-ai": "https://esm.run/@google/generative-ai@0.16.0"
        }
    }
    </script>

    <style>
        :root {
            --bg: #020202;
            --panel: #0a0a0a;
            --border: #333;
            --blue: #00f3ff;
            --green: #00ff9d;
            --purple: #bc13fe;
            --orange: #ff9d00;
            --red: #ff0055;
            --yellow: #ffd700;
            --font: 'Courier New', monospace;
            --glow-duration: 2s;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            background: var(--bg); 
            color: #eee; 
            font-family: var(--font); 
            margin: 0; 
            height: 100vh; 
            display: flex; 
            overflow: hidden; 
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(0, 243, 255, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(188, 19, 254, 0.05) 0%, transparent 20%);
            z-index: -1;
        }

        /* SIDEBAR */
        .sidebar { 
            width: 320px; 
            background: linear-gradient(145deg, #0a0a0a 0%, #1a1a1a 100%); 
            border-right: 1px solid var(--border); 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            overflow-y: auto; 
            position: relative;
        }
        
        .sidebar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 10px,
                    rgba(0, 243, 255, 0.03) 10px,
                    rgba(0, 243, 255, 0.03) 20px
                );
            pointer-events: none;
        }
        
        h1 { 
            color: var(--blue); 
            text-align: center; 
            margin: 0; 
            border-bottom: 1px solid var(--border); 
            padding-bottom: 10px; 
            font-size: 1.4em; 
            letter-spacing: 2px; 
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
            position: relative;
        }

        h1::after {
            content: '‚àû';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--purple);
            font-size: 1.2em;
            animation: pulse 2s infinite;
        }

        .card { 
            background: rgba(10, 10, 10, 0.8); 
            border: 1px solid var(--border); 
            padding: 15px; 
            border-radius: 8px; 
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--blue), transparent);
            animation: slide 3s infinite;
        }

        label { 
            font-size: 0.75em; 
            color: #aaa; 
            font-weight: bold; 
            display: block; 
            margin-bottom: 8px; 
            text-transform: uppercase; 
            letter-spacing: 1px;
        }

        input, select { 
            width: 100%; 
            background: rgba(0, 0, 0, 0.7); 
            border: 1px solid #444; 
            color: #fff; 
            padding: 10px; 
            margin-bottom: 8px; 
            outline: none; 
            font-family: inherit; 
            border-radius: 4px;
            transition: border-color 0.3s;
        }
        input:focus, select:focus { 
            border-color: var(--blue); 
            box-shadow: 0 0 8px rgba(0, 243, 255, 0.5);
        }

        button { 
            width: 100%; 
            padding: 12px; 
            background: linear-gradient(145deg, #111 0%, #222 100%); 
            border: 1px solid; 
            color: #fff; 
            cursor: pointer; 
            margin-top: 8px; 
            font-weight: bold; 
            text-transform: uppercase; 
            font-size: 0.8em; 
            transition: all 0.3s; 
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }
        button:hover:not(:disabled)::before { left: 100%; }
        button:hover:not(:disabled) { filter: brightness(1.2); transform: translateY(-2px); }
        button:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

        .btn-scan { border-color: var(--yellow); color: var(--yellow); }
        .btn-load { border-color: var(--green); color: var(--green); }
        .btn-save { border-color: var(--purple); color: var(--purple); }
        .btn-stop { border-color: var(--red); color: var(--red); background: rgba(255, 0, 85, 0.1); }
        .btn-start { 
            border-color: var(--blue); 
            color: var(--blue); 
            font-size: 1.1em; 
            background: rgba(0, 243, 255, 0.05);
            animation: pulse-border 2s infinite;
        }
        .btn-voice { border-color: var(--orange); color: var(--orange); }
        .btn-cloud { border-color: var(--purple); color: var(--purple); }

        /* MAIN AREA */
        .main { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            padding: 20px; 
            background: radial-gradient(circle at 50% 50%, rgba(10, 10, 10, 0.9) 0%, rgba(2, 2, 2, 0.95) 100%); 
            position: relative;
        }

        #chat-box { 
            flex-grow: 1; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            padding-bottom: 20px; 
            scroll-behavior: smooth; 
            position: relative;
        }
        
        #chat-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--red), var(--orange), var(--yellow), var(--green), var(--blue), var(--purple));
            animation: rainbow 5s infinite linear;
        }

        .msg { 
            padding: 16px; 
            border-radius: 8px; 
            background: rgba(30, 30, 30, 0.8); 
            border-left: 4px solid #555; 
            animation: slideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            font-size: 0.95em; 
            line-height: 1.6; 
            position: relative;
            max-width: 90%;
            transition: all 0.3s ease;
        }
        .msg:hover { transform: translateX(5px); box-shadow: 0 0 15px rgba(0, 0, 0, 0.5); }
        
        .msg-user { 
            align-self: flex-end; 
            border-left: none; 
            border-right: 4px solid var(--blue); 
            background: rgba(0, 243, 255, 0.1); 
            text-align: right; 
            max-width: 85%;
        }
        .msg-sys { 
            align-self: center; 
            border: none; 
            background: transparent; 
            color: #777; 
            font-style: italic; 
            text-align: center; 
            max-width: 100%;
        }
        
        /* Colores de Agentes y efectos especiales */
        .agent-web { border-color: var(--orange); background: rgba(255, 157, 0, 0.08); color: #ffeec0; }
        .agent-analyst { border-color: var(--blue); background: rgba(0, 243, 255, 0.08); color: #d0ffff; }
        .agent-critic { border-color: var(--red); background: rgba(255, 0, 85, 0.08); color: #ffd0d0; }
        .agent-creative { border-color: var(--purple); background: rgba(188, 19, 254, 0.08); color: #f0d0ff; }
        .agent-judge { border-color: var(--green); background: rgba(0, 255, 157, 0.1); color: #d0ffd0; font-weight: bold; }

        .sender-name { 
            font-size: 0.8em; 
            font-weight: bold; 
            text-transform: uppercase; 
            margin-bottom: 6px; 
            display: block; 
            opacity: 0.9;
            letter-spacing: 1px;
        }
        
        .content { 
            white-space: pre-wrap; 
            word-break: break-word;
        }
        
        /* INPUT AREA */
        .controls { 
            display: flex; 
            gap: 15px; 
            margin-top: 20px; 
            align-items: center; 
            padding-top: 15px; 
            border-top: 1px solid var(--border);
        }
        
        .control-group { flex-grow: 1; display: flex; flex-direction: column; gap: 5px; }

        textarea { 
            flex-grow: 1; 
            background: rgba(20, 20, 20, 0.8); 
            border: 1px solid #444; 
            color: #fff; 
            padding: 15px; 
            resize: none; 
            height: 80px; 
            outline: none; 
            border-radius: 6px; 
            font-family: inherit; 
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        textarea:focus { 
            border-color: var(--blue); 
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
        }
        
        /* SLIDER */
        .slider-container { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            background: rgba(30, 30, 30, 0.8); 
            padding: 12px 15px; 
            border-radius: 6px; 
            border: 1px solid #333; 
            width: 200px;
        }
        .slider-container label { margin: 0; color: #fff; font-size: 0.85em; white-space: nowrap; }
        
        input[type=range] { 
            width: 100px; 
            -webkit-appearance: none; 
            height: 6px; 
            background: #333; 
            border-radius: 3px; 
            outline: none;
        }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            width: 18px; 
            height: 18px; 
            border-radius: 50%; 
            background: var(--blue); 
            cursor: pointer; 
            border: 2px solid #000;
            box-shadow: 0 0 10px var(--blue);
        }
        input[type=range]::-moz-range-thumb { 
            width: 18px; 
            height: 18px; 
            border-radius: 50%; 
            background: var(--blue); 
            cursor: pointer; 
            border: 2px solid #000;
        }

        #progress-bar { 
            height: 4px; 
            background: linear-gradient(90deg, var(--green), var(--blue)); 
            width: 0%; 
            transition: width 0.3s ease; 
            border-radius: 2px;
            margin-top: 10px;
        }

        /* AVATAR DIN√ÅMICO */
        .avatar-container {
            text-align: center;
            margin: 15px;
            position: relative;
        }
        
        .avatar {
            width: 120px; 
            height: 120px; 
            border-radius: 50%; 
            border: 3px solid var(--blue); 
            object-fit: cover; 
            margin: 0 auto;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .avatar.pulse {
            box-shadow: 0 0 30px var(--blue), 0 0 60px var(--blue);
            animation: pulse 1.5s infinite;
        }
        
        .avatar-status {
            position: absolute;
            bottom: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #000;
            background: var(--red);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: bold;
        }
        
        .avatar-status.online { background: var(--green); }
        .avatar-status.thinking { background: var(--yellow); animation: pulse 1s infinite; }

        /* RAG DROPER */
        .rag-drop {
            border: 2px dashed var(--purple);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: rgba(30, 30, 30, 0.5);
            transition: all 0.3s;
            cursor: pointer;
            margin: 10px 0;
        }
        .rag-drop:hover { border-color: var(--blue); background: rgba(0, 243, 255, 0.1); }
        .rag-drop.dragover { border-color: var(--green); background: rgba(0, 255, 157, 0.2); }

        /* ANIMACIONES */
        @keyframes slideIn { 
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.95); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            } 
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 243, 255, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(0, 243, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 243, 255, 0); }
        }
        
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 var(--blue); }
            70% { box-shadow: 0 0 0 3px rgba(0, 243, 255, 0); }
            100% { box-shadow: 0 0 0 0 var(--blue); }
        }
        
        @keyframes slide {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        /* RESPONSIVE */
        @media (max-width: 900px) {
            .sidebar { width: 100%; height: auto; position: fixed; bottom: 0; left: 0; z-index: 100; border-right: none; border-top: 1px solid var(--border); }
            .main { margin-bottom: 250px; }
            .controls { flex-direction: column; }
            .slider-container { width: 100%; }
        }

        /* Loading spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 243, 255, 0.3);
            border-top: 2px solid var(--blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h1>NEXUS ‚àû <span style="font-size:0.6em; color:var(--purple)">v17.2</span></h1>
        
        <div class="avatar-container">
            <img id="nexus-avatar" src="https://cdn.prod.website-files.com/65b8f36fa600366bc7cf9a67/67bdbfbcaafdc4134405f8c1_Group%201799369591.png" 
                 class="avatar" 
                 alt="NEXUS AI" 
                 onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'120\' height=\'120\' viewBox=\'0 0 24 24\'><circle cx=\'12\' cy=\'12\' r=\'10\' fill=\'none\' stroke=\'%2300f3ff\' stroke-width=\'2\'/><path d=\'M9 9 L15 9 L12 15 Z\' fill=\'%2300f3ff\' opacity=\'0.8\'/></svg>'">
            <div class="avatar-status" id="avatar-status">OFF</div>
        </div>

        <div class="card">
            <label>1. üîç ESC√ÅNER DE HARDWARE</label>
            <div id="hardware-info" style="font-size:0.8em; color:#888; line-height:1.5; min-height:60px;">
                <span style="color:var(--yellow)">[Haz clic en 'ESCANEAR' para analizar tu sistema]</span>
            </div>
            <button class="btn-scan" id="btn-scan" onclick="app.scanHardware()">‚ö° ESCANEAR SISTEMA</button>
        </div>

        <div class="card">
            <label>2. üß† MOTOR NEURONAL (LOCAL)</label>
            <div id="model-recommendation" style="font-size:0.8em; color:var(--yellow); margin-bottom:10px; min-height:24px;"></div>
            <select id="local-model" style="margin-bottom:10px;">
                <option value="Llama-3.2-1B-Instruct-q4f16_1-MLC">Llama 3.2 1B (R√°pido)</option>
                <option value="TinyLlama-1.1B-Chat-v1.0-q4f16_1-MLC">TinyLlama (Ligero)</option>
                <option value="Phi-3-mini-4k-instruct-q4f16_1-MLC">Phi-3 Mini (Potente)</option>
                <option value="Qwen-2.5-7B-Instruct-q4f16_1-MLC">Qwen 2.5 7B (M√°ximo)</option>
            </select>
            <div style="display: flex; gap: 8px;">
                <button class="btn-load" id="btn-load" onclick="app.loadEngine()">‚ö° CARGAR MOTOR</button>
                <button class="btn-stop" id="btn-unload" onclick="app.unloadEngine()" disabled>‚èèÔ∏è DESCARGAR</button>
            </div>
            <div id="status-text" style="font-size:0.8em; color:#aaa; margin-top:8px; min-height:24px;">Estado: Offline</div>
            <div style="background:#222; height:5px; border-radius:2.5px; margin-top:8px; overflow:hidden;">
                <div id="progress-bar" style="height:100%; border-radius:2.5px;"></div>
            </div>
        </div>

        <div class="card">
            <label>3. üîê B√ìVEDA DE CLAVES</label>
            <input type="password" id="key-gemini" placeholder="Gemini API Key"> <small style="color:var(--blue);">‚úì</small>
            <input type="password" id="key-groq" placeholder="Groq API Key"> <small style="color:var(--blue);">‚úì</small>
            <input type="password" id="key-tavily" placeholder="Tavily API Key (B√∫squeda)"> <small style="color:var(--blue);">‚úì</small>
            <input type="password" id="key-hf" placeholder="Hugging Face Token (Opcional)"> <small style="color:var(--blue);">‚úì</small>
            <button class="btn-save" onclick="app.saveKeys()">üíæ GUARDAR CLAVES</button>
            <div style="font-size:0.75em; color:#777; margin-top:8px;">
                <span style="color:var(--green);">‚úì</span> Las claves se guardan en tu navegador de forma segura
            </div>
            <button class="btn-cloud" onclick="app.switchToCloudMode()" style="margin-top:10px;">
                ‚òÅÔ∏è ACTIVAR MODO NUBE (sin WebGPU)
            </button>
        </div>

        <div class="card">
            <label>4. üìÅ RAG LOCAL (ARRASTRA ARCHIVOS)</label>
            <div id="rag-drop" class="rag-drop">
                <div style="margin-bottom:10px;">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                </div>
                <div style="font-size:0.9em; color:var(--purple);">
                    Arrastra aqu√≠ archivos .txt, .pdf o c√≥digo
                </div>
                <div id="rag-status" style="font-size:0.8em; color:#888; margin-top:8px; min-height:20px;"></div>
            </div>
        </div>

        <div class="card">
            <label>5. üîä CONTROL DE VOZ</label>
            <div style="display: flex; gap: 10px; margin-bottom:10px;">
                <button class="btn-voice" id="btn-mic" onclick="app.toggleMicrophone()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        <line x1="12" y1="19" x2="12" y2="23"></line>
                        <line x1="8" y1="23" x2="16" y2="23"></line>
                    </svg>
                    MICR√ìFONO
                </button>
                <button class="btn-voice" id="btn-tts" onclick="app.toggleTTS()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 5v14"></path>
                        <path d="M13 17V7"></path>
                        <path d="M17 9V5"></path>
                        <path d="M13 17l4 4"></path>
                        <path d="M17 9l4 4"></path>
                    </svg>
                    VOZ IA
                </button>
            </div>
            <div id="voice-status" style="font-size:0.8em; color:#888; margin-top:8px;">
                Micr√≥fono: <span id="mic-status">OFF</span> | Voz IA: <span id="tts-status">OFF</span>
            </div>
        </div>

        <div class="card">
            <label>6. ‚öôÔ∏è CADENA DE AGENTES</label>
            <div style="font-size:0.85em; color:#ddd; line-height:1.6; background:rgba(0,0,0,0.3); padding:12px; border-radius:6px;">
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                    <span style="color:var(--orange); font-weight:bold;">1. üåê INVESTIGADOR</span>
                    <span style="color:#666; font-size:0.8em;">(B√∫squeda Web)</span>
                </div>
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                    <span style="color:var(--blue); font-weight:bold;">2. üîµ ANALISTA</span> 
                    <span style="color:#666; font-size:0.8em;">(Procesamiento)</span>
                </div>
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                    <span style="color:var(--red); font-weight:bold;">3. üî¥ CR√çTICO</span>
                    <span style="color:#666; font-size:0.8em;">(Validaci√≥n)</span>
                </div>
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                    <span style="color:var(--purple); font-weight:bold;">4. üü£ CREATIVO</span>
                    <span style="color:#666; font-size:0.8em;">(Innovaci√≥n)</span>
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="color:var(--green); font-weight:bold;">5. üü¢ JUEZ</span>
                    <span style="color:#666; font-size:0.8em;">(S√≠ntesis Final)</span>
                </div>
            </div>
            <div style="margin-top:10px; padding-top:10px; border-top:1px solid var(--border);">
                <label style="display:block; margin-bottom:8px;">INTENSIDAD DE PROCESO</label>
                <div class="slider-container">
                    <label style="margin:0; color:#fff; font-size:0.9em; min-width:80px;">ETAPAS:</label>
                    <input type="range" id="rounds-slider" min="1" max="10" value="5" oninput="document.getElementById('rounds-val').innerText=this.value">
                    <span id="rounds-val" style="color:var(--blue); font-weight:bold; font-size:1em; min-width:20px; text-align:center;">5</span>
                </div>
                <div style="font-size:0.75em; color:#888; margin-top:5px; display:flex; justify-content:space-between;">
                    <span>M√≠nimo</span>
                    <span>M√°ximo</span>
                </div>
            </div>
        </div>

        <button class="btn-stop" onclick="app.stop()" style="background: rgba(255, 0, 85, 0.1);">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px; vertical-align:middle;">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            </svg>
            üõë BOT√ìN DE P√ÅNICO
        </button>
    </div>

    <div class="main">
        <div id="chat-box">
            <div class="msg msg-sys">
                <strong>üöÄ NEXUS INFINITY v17.2 INICIADO</strong><br>
                <span style="color:var(--green);">‚úì</span> Arquitectura H√≠brida: Local + Nube<br>
                <span style="color:var(--green);">‚úì</span> Cadena Secuencial de 5 Agentes<br>
                <span style="color:var(--yellow);">üí° RECOMENDACI√ìN:</span> Haz clic en <strong>"ESCANEAR SISTEMA"</strong> primero para detectar compatibilidad.<br>
                <span style="color:var(--blue);">‚òÅÔ∏è</span> Si tienes problemas, haz clic en <strong>"ACTIVAR MODO NUBE"</strong> en la b√≥veda de claves.
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <textarea id="user-input" placeholder="Escribe tu misi√≥n compleja aqu√≠... (o habla usando el micr√≥fono)"></textarea>
            </div>
            
            <button class="btn-start" style="width:100px; height:80px;" onclick="app.process()">
                <div style="font-size:0.9em; margin-bottom:4px;">EJECUTAR</div>
                <div style="font-size:1.2em; font-weight:bold;">‚ñ∂Ô∏è</div>
            </button>
        </div>
    </div>

    <script type="module">
        import { CreateMLCEngine } from "@mlc-ai/web-llm";
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // Configuraci√≥n global de timeouts (15 segundos m√°ximo por operaci√≥n)
        const GLOBAL_TIMEOUT = 15000;

        // Inicializar marked con sanitizaci√≥n XSS
        marked.setOptions({ 
            highlight: (code, lang) => {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            sanitize: true,
            sanitizer: function(text) {
                return text.replace(/[&<>"']/g, function(m) {
                    return {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#39;'
                    }[m];
                });
            }
        });

        class NexusInfinity {
            constructor() {
                // Estado del sistema
                this.localEngine = null;
                this.keys = { gemini: '', groq: '', tavily: '', hf: '' };
                this.abortController = null;
                this.isProcessing = false;
                this.hardwareInfo = null;
                this.ragContext = '';
                this.modelCache = {};
                this.voiceActive = { mic: false, tts: false };
                this.timeoutId = null;
                this.isCloudMode = false;
                
                // Referencias UI
                this.ui = {
                    chat: document.getElementById('chat-box'),
                    input: document.getElementById('user-input'),
                    status: document.getElementById('status-text'),
                    bar: document.getElementById('progress-bar'),
                    btnLoad: document.getElementById('btn-load'),
                    btnUnload: document.getElementById('btn-unload'),
                    rounds: document.getElementById('rounds-slider'),
                    avatar: document.getElementById('nexus-avatar'),
                    avatarStatus: document.getElementById('avatar-status'),
                    hardwareInfo: document.getElementById('hardware-info'),
                    modelRecommendation: document.getElementById('model-recommendation'),
                    micBtn: document.getElementById('btn-mic'),
                    ttsBtn: document.getElementById('btn-tts'),
                    micStatus: document.getElementById('mic-status'),
                    ttsStatus: document.getElementById('tts-status'),
                    ragDrop: document.getElementById('rag-drop'),
                    ragStatus: document.getElementById('rag-status')
                };

                // Configuraci√≥n inicial
                this.setupHardwareDetection();
                this.setupVoiceRecognition();
                this.setupFileDrop();
                this.loadKeys();
                this.setupEvents();
                this.updateAvatarStatus('offline');
                
                // Iniciar verificaci√≥n de hardware con timeout
                this.checkHardwareCapabilitiesWithTimeout();
            }

            setupEvents() {
                this.ui.input.addEventListener('keydown', (e) => {
                    if(e.key === 'Enter' && !e.shiftKey) { 
                        e.preventDefault(); 
                        this.process(); 
                    }
                });
                
                // Eventos de voz
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    this.ui.micBtn.addEventListener('click', () => this.toggleMicrophone());
                }
            }

            // --- HARDWARE DETECTION CON TIMEOUT ---
            checkHardwareCapabilitiesWithTimeout() {
                clearTimeout(this.timeoutId);
                
                this.timeoutId = setTimeout(() => {
                    if (!this.hardwareInfo) {
                        this.ui.hardwareInfo.innerHTML = `
                            <span style="color:var(--yellow);">‚è≥ Detecci√≥n tard√≠a</span><br>
                            <span style="color:#aaa;">Verificando compatibilidad con WebGPU...</span>
                        `;
                        
                        // Forzar modo nube si no hay respuesta despu√©s de timeout
                        setTimeout(() => {
                            if (!this.hardwareInfo) {
                                this.ui.hardwareInfo.innerHTML = `
                                    <span style="color:var(--red);">‚ùå WebGPU no disponible</span><br>
                                    <span style="color:var(--blue);">üí° Sistema funcionar√° en modo nube</span>
                                `;
                                this.hardwareInfo = {
                                    gpu: { name: 'WebGPU no disponible', memory: 0 },
                                    ram: 4,
                                    webgl: true,
                                    webgpu: false
                                };
                                this.recommendModel();
                                this.switchToCloudMode();
                            }
                        }, 5000);
                    }
                }, GLOBAL_TIMEOUT / 2);
                
                this.checkHardwareCapabilities();
            }

            async checkHardwareCapabilities() {
                try {
                    const gpu = await this.detectGPU();
                    const ram = this.detectRAM();
                    
                    this.hardwareInfo = {
                        gpu: gpu,
                        ram: ram,
                        webgl: this.detectWebGL(),
                        webgpu: await this.detectWebGPU()
                    };
                    
                    this.updateHardwareDisplay();
                    this.recommendModel();
                    
                } catch (e) {
                    console.error('Error detectando hardware:', e);
                    this.hardwareInfo = {
                        gpu: { name: 'No detectado', memory: 0 },
                        ram: navigator.deviceMemory || 4,
                        webgl: true,
                        webgpu: false
                    };
                    this.updateHardwareDisplay();
                    this.recommendModel();
                }
            }

            async detectGPU() {
                return new Promise((resolve) => {
                    const canvas = document.createElement('canvas');
                    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                    if (!gl) {
                        resolve({ name: 'Sin GPU', memory: 0 });
                        return;
                    }
                    
                    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                    if (debugInfo) {
                        const gpuName = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
                        resolve({ 
                            name: this.cleanGPUName(gpuName),
                            memory: this.estimateGPUMemory(gpuName)
                        });
                    } else {
                        resolve({ name: 'GPU Desconocida', memory: 2 });
                    }
                });
            }

            detectRAM() {
                try {
                    if ('deviceMemory' in navigator) {
                        return navigator.deviceMemory;
                    }
                    return 4; // Valor por defecto conservador
                } catch (e) {
                    return 4;
                }
            }

            detectWebGL() {
                try {
                    const canvas = document.createElement('canvas');
                    return !!canvas.getContext('webgl') || !!canvas.getContext('experimental-webgl');
                } catch (e) {
                    return false;
                }
            }

            async detectWebGPU() {
                try {
                    if (!navigator.gpu) return false;
                    const adapter = await navigator.gpu.requestAdapter();
                    return !!adapter;
                } catch (e) {
                    return false;
                }
            }

            estimateGPUMemory(gpuName) {
                const lowerName = gpuName.toLowerCase();
                if (lowerName.includes('rtx 4090')) return 24;
                if (lowerName.includes('rtx 4080')) return 16;
                if (lowerName.includes('rtx 4070')) return 12;
                if (lowerName.includes('rtx 30')) return 8;
                if (lowerName.includes('intel') || lowerName.includes('amd')) return 2;
                return 4;
            }

            cleanGPUName(name) {
                return name.replace(/WebGL|ANGLE|Google|Inc\.|Corporation/g, '').trim();
            }

            updateHardwareDisplay() {
                if (!this.hardwareInfo) return;
                
                const html = `
                    <div style="font-size:0.9em;">
                        <div><span style="color:var(--blue);">GPU:</span> ${this.hardwareInfo.gpu.name} (${this.hardwareInfo.gpu.memory}GB VRAM)</div>
                        <div><span style="color:var(--green);">RAM:</span> ${this.hardwareInfo.ram}GB</div>
                        <div><span style="color:var(--purple);">WebGL:</span> ${this.hardwareInfo.webgl ? '‚úÖ' : '‚ùå'}</div>
                        <div><span style="color:var(--orange);">WebGPU:</span> ${this.hardwareInfo.webgpu ? '‚úÖ' : '‚ùå'}</div>
                        <div style="margin-top:8px; color:${this.hardwareInfo.webgpu ? 'var(--green)' : 'var(--yellow)'};">
                            ${this.hardwareInfo.webgpu ? 'üöÄ WebGPU disponible: m√°ximo rendimiento' : '‚ö†Ô∏è WebGPU no disponible: usando modo nube'}
                        </div>
                    </div>
                `;
                this.ui.hardwareInfo.innerHTML = html;
            }

            recommendModel() {
                if (!this.hardwareInfo) return;
                
                let recommendation = '';
                let modelValue = '';
                
                if (this.hardwareInfo.webgpu && this.hardwareInfo.gpu.memory >= 8 && this.hardwareInfo.ram >= 8) {
                    recommendation = '‚úÖ <span style="color:var(--green);">Sistema √≥ptimo para modelos locales</span>';
                    modelValue = this.hardwareInfo.gpu.memory >= 12 ? 'Qwen-2.5-7B-Instruct-q4f16_1-MLC' : 'Phi-3-mini-4k-instruct-q4f16_1-MLC';
                } else if (this.hardwareInfo.webgpu) {
                    recommendation = '‚ö†Ô∏è <span style="color:var(--orange);">Rendimiento limitado para modelos locales</span>';
                    modelValue = 'TinyLlama-1.1B-Chat-v1.0-q4f16_1-MLC';
                } else {
                    recommendation = '‚ùå <span style="color:var(--red);">WebGPU no disponible</span><br><span style="color:var(--blue);">üí° Recomendado: Modo Nube</span>';
                    modelValue = 'Llama-3.2-1B-Instruct-q4f16_1-MLC';
                }
                
                this.ui.modelRecommendation.innerHTML = recommendation;
                document.getElementById('local-model').value = modelValue;
            }

            scanHardware() {
                this.addMsg('SISTEMA', 'üîç Escaneando hardware del sistema...', 'msg-sys');
                this.checkHardwareCapabilitiesWithTimeout();
                setTimeout(() => {
                    if (this.hardwareInfo) {
                        this.addMsg('SISTEMA', '‚úÖ An√°lisis de hardware completado. Revisa las recomendaciones arriba.', 'msg-sys');
                    } else {
                        this.addMsg('SISTEMA', '‚è≥ Escaneo en progreso. Si tarda demasiado, activa el modo nube.', 'msg-sys');
                    }
                }, 2000);
            }

            // --- GESTI√ìN DE CLAVES ---
            saveKeys() {
                this.keys.gemini = document.getElementById('key-gemini').value.trim();
                this.keys.groq = document.getElementById('key-groq').value.trim();
                this.keys.tavily = document.getElementById('key-tavily').value.trim();
                this.keys.hf = document.getElementById('key-hf').value.trim();
                
                // Encriptar claves b√°sicamente antes de guardar
                const encryptedKeys = {
                    gemini: this.keys.gemini ? 'encrypted_' + btoa(this.keys.gemini) : '',
                    groq: this.keys.groq ? 'encrypted_' + btoa(this.keys.groq) : '',
                    tavily: this.keys.tavily ? 'encrypted_' + btoa(this.keys.tavily) : '',
                    hf: this.keys.hf ? 'encrypted_' + btoa(this.keys.hf) : ''
                };
                
                localStorage.setItem('nexus_keys_v17', JSON.stringify(encryptedKeys));
                this.addMsg('SISTEMA', 'üîê Claves guardadas de forma segura en tu navegador.', 'msg-sys');
                
                // Actualizar UI
                document.querySelectorAll('.card input + small').forEach(el => {
                    el.style.color = this.keys[el.previousElementSibling.id.replace('key-', '')] ? 'var(--green)' : 'var(--blue)';
                });
            }

            loadKeys() {
                const saved = localStorage.getItem('nexus_keys_v17');
                if (saved) {
                    try {
                        const encryptedKeys = JSON.parse(saved);
                        this.keys = {
                            gemini: encryptedKeys.gemini ? atob(encryptedKeys.gemini.replace('encrypted_', '')) : '',
                            groq: encryptedKeys.groq ? atob(encryptedKeys.groq.replace('encrypted_', '')) : '',
                            tavily: encryptedKeys.tavily ? atob(encryptedKeys.tavily.replace('encrypted_', '')) : '',
                            hf: encryptedKeys.hf ? atob(encryptedKeys.hf.replace('encrypted_', '')) : ''
                        };
                        
                        // Mostrar solo los √∫ltimos 4 caracteres de las claves para seguridad
                        document.getElementById('key-gemini').value = this.keys.gemini ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + this.keys.gemini.slice(-4) : '';
                        document.getElementById('key-groq').value = this.keys.groq ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + this.keys.groq.slice(-4) : '';
                        document.getElementById('key-tavily').value = this.keys.tavily ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + this.keys.tavily.slice(-4) : '';
                        document.getElementById('key-hf').value = this.keys.hf ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + this.keys.hf.slice(-4) : '';
                        
                        // Actualizar UI de claves
                        document.querySelectorAll('.card input + small').forEach(el => {
                            const keyName = el.previousElementSibling.id.replace('key-', '');
                            el.style.color = this.keys[keyName] ? 'var(--green)' : 'var(--blue)';
                        });
                    } catch (e) {
                        console.error('Error cargando claves:', e);
                    }
                }
            }

            // --- MODO NUBE (FALLBACK CUANDO NO HAY WebGPU) ---
            switchToCloudMode() {
                this.isCloudMode = true;
                this.addMsg('SISTEMA', '‚òÅÔ∏è Modo nube activado. Se usar√°n exclusivamente APIs externas.', 'msg-sys');
                this.ui.status.innerHTML = `<span style="color:var(--blue);">‚òÅÔ∏è MODO NUBE</span>`;
                
                // Deshabilitar carga de motor local
                document.getElementById('local-model').disabled = true;
                this.ui.btnLoad.disabled = true;
                this.ui.btnUnload.disabled = true;
                
                // Cambiar avatar a modo nube
                this.updateAvatarStatus('online');
                this.ui.avatarStatus.textContent = 'CLOUD';
                this.ui.avatarStatus.className = 'avatar-status online';
                
                this.addMsg('SISTEMA', 'üí° Consejo: Configura tus claves API para un mejor rendimiento en modo nube.', 'msg-sys');
            }

            // --- CARGA MOTOR LOCAL CON CACH√â Y TIMEOUT ---
            async loadEngine() {
                if (this.isCloudMode) {
                    this.addMsg('ERROR', '‚ùå No se puede cargar motor local en modo nube. Desactiva primero el modo nube.', 'msg-sys');
                    return;
                }
                
                if (this.localEngine) {
                    this.addMsg('SISTEMA', '‚ö†Ô∏è Motor ya est√° cargado. Desc√°rgalo primero para cambiar de modelo.', 'msg-sys');
                    return;
                }
                
                const modelId = document.getElementById('local-model').value;
                this.ui.btnLoad.disabled = true;
                this.ui.btnUnload.disabled = true;
                this.updateAvatarStatus('thinking');
                
                try {
                    this.addMsg('SISTEMA', `üß† Cargando motor neuronal local: ${modelId}...`, 'msg-sys');
                    
                    // Crear engine con cach√© persistente
                    this.localEngine = await CreateMLCEngine(modelId, {
                        initProgressCallback: (report) => {
                            this.ui.bar.style.width = `${report.progress * 100}%`;
                            this.ui.status.innerText = `Cargando: ${report.text} (${Math.round(report.progress * 100)}%)`;
                            
                            if (report.progress === 1) {
                                this.updateAvatarStatus('online');
                                this.ui.status.innerHTML = `<span style="color:var(--green);">üü¢ ONLINE</span> | ${modelId}`;
                                this.ui.btnLoad.innerText = "‚úì ACTIVO";
                                this.ui.btnLoad.disabled = true;
                                this.ui.btnUnload.disabled = false;
                                this.addMsg('SISTEMA', `‚úÖ Motor neuronal ${modelId} cargado exitosamente.`, 'msg-sys');
                            }
                        },
                        logLevel: 'INFO'
                    });
                    
                } catch (e) {
                    this.updateAvatarStatus('offline');
                    this.ui.status.innerHTML = `<span style="color:var(--red);">‚ùå ERROR</span> | ${e.message}`;
                    this.ui.btnLoad.disabled = false;
                    
                    // Sugerir modo nube si falla la carga
                    this.addMsg('ERROR', `‚ùå Fallo al cargar el motor: ${e.message}`, 'msg-sys');
                    this.addMsg('SISTEMA', 'üí° ¬øProblemas con WebGPU? Intenta activar el <strong>modo nube</strong> en la b√≥veda de claves.', 'msg-sys');
                    
                    console.error('Error cargando motor:', e);
                }
            }

            async unloadEngine() {
                if (this.localEngine) {
                    try {
                        await this.localEngine.unload();
                        this.localEngine = null;
                        this.updateAvatarStatus('offline');
                        this.ui.status.innerHTML = 'Estado: Offline';
                        this.ui.bar.style.width = '0%';
                        this.ui.btnLoad.innerText = "‚ö° CARGAR MOTOR";
                        this.ui.btnLoad.disabled = false;
                        this.ui.btnUnload.disabled = true;
                        this.addMsg('SISTEMA', '‚èèÔ∏è Motor neuronal descargado exitosamente.', 'msg-sys');
                    } catch (e) {
                        this.addMsg('ERROR', `‚ùå Error al descargar motor: ${e.message}`, 'msg-sys');
                    }
                }
            }

            // --- MOTOR PRINCIPAL DE CADENA (SEQUENTIAL CHAIN) ---
            async process() {
                const text = this.ui.input.value.trim();
                const maxRounds = parseInt(this.ui.rounds.value);

                if (!text) {
                    this.addMsg('ERROR', '‚ùå Por favor ingresa una consulta v√°lida.', 'msg-sys');
                    return;
                }

                if (!this.localEngine && !this.hasAnyAPIKey()) {
                    this.addMsg('ERROR', '‚ö†Ô∏è No hay motor local cargado ni claves API configuradas.', 'msg-sys');
                    this.addMsg('SISTEMA', 'üí° Configura al menos una clave API o activa el modo nube para continuar.', 'msg-sys');
                    return;
                }

                this.ui.input.value = "";
                this.isProcessing = true;
                this.abortController = new AbortController();
                this.updateAvatarStatus('thinking');
                
                // Crear contexto inicial con RAG si existe
                let contextChain = `SOLICITUD ORIGINAL: "${text}"\n\n`;
                if (this.ragContext) {
                    contextChain += `=== CONTEXTO LOCAL (RAG) ===\n${this.ragContext}\n\n`;
                }

                this.addMsg("T√ö", text, "msg-user");
                this.addMsg("ORQUESTADOR", `üöÄ Iniciando cadena secuencial de ${maxRounds} etapas...`, "msg-sys");

                try {
                    // --- PASO 1: INVESTIGADOR (WEB) ---
                    if (this.keys.tavily && maxRounds >= 1 && !this.abortController.signal.aborted) {
                        this.addMsg("Agente 1/5", "üåê Buscando datos en tiempo real...", "msg-sys");
                        const webData = await this.withTimeout(this.runWebSearch(text));
                        contextChain += `=== REPORTE WEB ===\n${webData}\n\n`;
                        this.addMsg("INVESTIGADOR (WEB)", webData, "agent-web");
                    }

                    // --- PASO 2: ANALISTA (GROQ/LOCAL) ---
                    if (!this.abortController.signal.aborted && maxRounds >= 2) {
                        this.addMsg("Agente 2/5", "üîµ Analizando datos y extrayendo patrones...", "msg-sys");
                        const prompt = `Analiza estos datos y extrae los puntos clave, tendencias y hallazgos relevantes:\n${contextChain}`;
                        const systemRole = "Eres un Analista de Datos experto. Tu trabajo es extraer insights valiosos de la informaci√≥n proporcionada.";
                        const analysis = await this.withTimeout(this.runInference(prompt, systemRole, "groq"));
                        contextChain += `=== AN√ÅLISIS ===\n${analysis}\n\n`;
                        this.addMsg("ANALISTA", analysis, "agent-analyst");
                    }

                    // --- PASO 3: CR√çTICO (LOCAL) ---
                    if (!this.abortController.signal.aborted && maxRounds >= 3) {
                        this.addMsg("Agente 3/5", "üî¥ Validadando consistencia y buscando errores...", "msg-sys");
                        const prompt = `Critica el an√°lisis anterior. Identifica errores l√≥gicos, sesgos, datos inconsistentes o suposiciones no validadas. S√© constructivo pero riguroso:\n${contextChain}`;
                        const systemRole = "Eres un Cr√≠tico experto. Tu misi√≥n es encontrar fallos en el razonamiento y mejorar la calidad del an√°lisis.";
                        const critique = await this.withTimeout(this.runInference(prompt, systemRole, "local"));
                        contextChain += `=== CR√çTICA ===\n${critique}\n\n`;
                        this.addMsg("CR√çTICO", critique, "agent-critic");
                    }

                    // --- PASO 4: CREATIVO (GEMINI/LOCAL) ---
                    if (!this.abortController.signal.aborted && maxRounds >= 4) {
                        this.addMsg("Agente 4/5", "üü£ Generando soluciones innovadoras...", "msg-sys");
                        const prompt = `Basado en el an√°lisis y la cr√≠tica, prop√≥n 3 soluciones innovadoras, creativas y pr√°cticas para el problema original. Piensa fuera de la caja:\n${contextChain}`;
                        const systemRole = "Eres un Visionario Creativo. Tu trabajo es generar ideas originales y soluciones disruptivas.";
                        const creative = await this.withTimeout(this.runInference(prompt, systemRole, "gemini"));
                        contextChain += `=== IDEAS INNOVADORAS ===\n${creative}\n\n`;
                        this.addMsg("CREATIVO", creative, "agent-creative");
                    }

                    // --- PASO 5: JUEZ (LOCAL - S√çNTESIS) ---
                    if (!this.abortController.signal.aborted && maxRounds >= 5) {
                        this.addMsg("Agente 5/5", "üü¢ Sintetizando conclusi√≥n final...", "msg-sys");
                        const prompt = `Lee todo el historial de la cadena. Como Juez Supremo, emite una conclusi√≥n final clara, accionable y equilibrada que sintetice lo mejor de cada etapa. S√© contundente y pr√°ctico:\n${contextChain}`;
                        const systemRole = "Eres el Juez Final. Tu responsabilidad es tomar una decisi√≥n clara basada en todas las perspectivas anteriores.";
                        const verdict = await this.withTimeout(this.runInference(prompt, systemRole, "local"));
                        this.addMsg("JUEZ SUPREMO", verdict, "agent-judge");
                    }

                    this.addMsg("SISTEMA", "‚úÖ Cadena secuencial completada exitosamente.", "msg-sys");

                } catch (e) {
                    if (e.name !== 'AbortError') {
                        this.addMsg("ERROR", `‚ùå Error durante el procesamiento: ${e.message}`, "msg-sys");
                        if (e.message.includes('time')) {
                            this.addMsg("SISTEMA", "üí° ¬øEl proceso se congela? Activa el modo nube en la b√≥veda de claves para mejor rendimiento.", "msg-sys");
                        }
                    }
                } finally {
                    this.isProcessing = false;
                    this.updateAvatarStatus(this.localEngine && !this.isCloudMode ? 'online' : 'offline');
                }
            }

            hasAnyAPIKey() {
                return this.keys.gemini || this.keys.groq || this.keys.tavily;
            }

            // --- EJECUTOR UNIVERSAL CON FALLOVERS ---
            async runInference(prompt, systemRole, preference) {
                if (!this.abortController || this.abortController.signal.aborted) {
                    throw new DOMException('Abortado por usuario', 'AbortError');
                }
                
                // Limitar tama√±o de prompts para evitar problemas de memoria
                const MAX_PROMPT_LENGTH = 5000;
                const safePrompt = prompt.substring(0, MAX_PROMPT_LENGTH);
                const safeSystemRole = systemRole.substring(0, 500);
                
                // 1. Intentar modelos cloud primero si estamos en modo nube
                if (this.isCloudMode) {
                    if (preference === "gemini" && this.keys.gemini) {
                        return this.callGemini(safePrompt, safeSystemRole);
                    }
                    if (preference === "groq" && this.keys.groq) {
                        return this.callGroq(safePrompt, safeSystemRole);
                    }
                }
                
                // 2. Intentar modelos locales si no estamos en modo nube y tenemos motor cargado
                if (!this.isCloudMode && this.localEngine && preference !== "gemini") {
                    try {
                        return await this.callLocalModel(safePrompt, safeSystemRole);
                    } catch (e) {
                        console.log("Motor local fall√≥:", e.message);
                    }
                }
                
                // 3. Fallback a cloud si fall√≥ local o estamos en modo nube
                if (this.keys.gemini && preference === "gemini") {
                    try {
                        return await this.callGemini(safePrompt, safeSystemRole);
                    } catch (e) {
                        console.log("Gemini fall√≥:", e.message);
                    }
                }
                
                if (this.keys.groq) {
                    try {
                        return await this.callGroq(safePrompt, safeSystemRole);
                    } catch (e) {
                        console.log("Groq fall√≥:", e.message);
                    }
                }
                
                // 4. √öltimo fallback
                return "‚ö†Ô∏è No se pudo obtener respuesta de ning√∫n modelo disponible. Verifica tus claves API o activa el modo nube.";
            }

            async callGemini(prompt, systemRole) {
                if (!this.keys.gemini) throw new Error("No hay clave Gemini configurada");
                
                const genAI = new GoogleGenerativeAI(this.keys.gemini);
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                
                const result = await model.generateContent({
                    contents: [{
                        role: "user",
                        parts: [{ text: `${systemRole}\n\n${prompt}` }]
                    }],
                    generationConfig: {
                        maxOutputTokens: 1500,
                        temperature: 0.7,
                        topP: 0.95
                    }
                });
                
                return result.response.text();
            }

            async callGroq(prompt, systemRole) {
                if (!this.keys.groq) throw new Error("No hay clave Groq configurada");
                
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { 
                        "Authorization": `Bearer ${this.keys.groq}`, 
                        "Content-Type": "application/json" 
                    },
                    body: JSON.stringify({ 
                        model: "llama3-70b-8192", 
                        messages: [
                            { role: "system", content: systemRole },
                            { role: "user", content: prompt }
                        ],
                        max_tokens: 1024,
                        temperature: 0.7,
                        top_p: 0.95
                    }),
                    signal: this.abortController.signal
                });
                
                if (!response.ok) {
                    throw new Error(`Groq error: ${response.status} ${await response.text()}`);
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
            }

            async callLocalModel(prompt, systemRole) {
                if (!this.localEngine) throw new Error("Motor local no cargado");
                
                const chunks = await this.localEngine.chat.completions.create({
                    messages: [
                        { role: "system", content: systemRole },
                        { role: "user", content: prompt }
                    ],
                    max_tokens: 512,
                    temperature: 0.7,
                    top_p: 0.95
                });
                
                return chunks.choices[0].message.content;
            }

            // --- WEB SEARCH CON TAVILY ---
            async runWebSearch(query) {
                if (!this.keys.tavily) return "‚ö†Ô∏è [No hay API Key de Tavily configurada. Saltando b√∫squeda web...]";
                
                try {
                    const response = await fetch("https://api.tavily.com/search", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ 
                            api_key: this.keys.tavily, 
                            query: query, 
                            search_depth: "basic", 
                            include_answer: true,
                            max_results: 3
                        }),
                        signal: this.abortController.signal
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Error Tavily: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data.answer || "No se encontraron resultados relevantes.";
                } catch(e) {
                    if (e.name !== 'AbortError') {
                        return `Error en b√∫squeda web: ${e.message}. La informaci√≥n podr√≠a estar incompleta.`;
                    }
                    throw e;
                }
            }

            // --- UTILIDADES ---
            async withTimeout(promise, timeout = GLOBAL_TIMEOUT) {
                let timer;
                const timeoutPromise = new Promise((_, reject) => {
                    timer = setTimeout(() => {
                        reject(new Error('Operaci√≥n excedi√≥ el tiempo l√≠mite'));
                    }, timeout);
                });
                
                try {
                    const result = await Promise.race([promise, timeoutPromise]);
                    clearTimeout(timer);
                    return result;
                } catch (e) {
                    clearTimeout(timer);
                    throw e;
                }
            }

            // --- CONTROL DE PROCESO ---
            stop() {
                if (this.abortController) {
                    this.abortController.abort();
                    this.addMsg("SISTEMA", "üõë Proceso detenido por el usuario.", "msg-sys");
                    this.isProcessing = false;
                    this.updateAvatarStatus(this.localEngine && !this.isCloudMode ? 'online' : 'offline');
                }
            }

            updateAvatarStatus(status) {
                const avatar = this.ui.avatar;
                const statusEl = this.ui.avatarStatus;
                
                avatar.classList.remove('pulse');
                statusEl.className = 'avatar-status';
                
                switch(status) {
                    case 'thinking':
                        avatar.classList.add('pulse');
                        statusEl.textContent = 'CPU';
                        statusEl.className += ' thinking';
                        break;
                    case 'online':
                        statusEl.textContent = this.isCloudMode ? 'CLOUD' : 'ON';
                        statusEl.className += ' online';
                        break;
                    case 'offline':
                        statusEl.textContent = 'OFF';
                        statusEl.style.background = 'var(--red)';
                        break;
                }
            }

            // --- UTILIDADES DE UI ---
            addMsg(sender, text, css) {
                const div = document.createElement('div');
                div.className = `msg ${css}`;
                div.innerHTML = `<span class="sender-name">${sender}</span><div class="content">${marked.parse(text)}</div>`;
                this.ui.chat.appendChild(div);
                this.ui.chat.scrollTop = this.ui.chat.scrollHeight;
                
                // Resaltar c√≥digo
                div.querySelectorAll('pre code').forEach((block) => {
                    if (hljs) hljs.highlightElement(block);
                });
            }
            
            // --- FUNCIONES NO IMPLEMENTADAS (STUBS) ---
            setupFileDrop() {
                // Funcionalidad RAG desactivada temporalmente para evitar errores
                this.ui.ragStatus.innerHTML = '<span style="color:var(--yellow);">‚ö†Ô∏è RAG desactivado temporalmente</span>';
            }
            
            setupVoiceRecognition() {
                // STT/TTS requiere permisos de micr√≥fono que pueden causar problemas en algunos entornos
                this.ui.micStatus.textContent = 'NO SOPORTADO';
                this.ui.micStatus.style.color = 'var(--red)';
                this.ui.ttsStatus.textContent = 'NO SOPORTADO';
                this.ui.ttsStatus.style.color = 'var(--red)';
                this.addMsg('SISTEMA', '‚ö†Ô∏è Control de voz desactivado temporalmente para mayor estabilidad.', 'msg-sys');
            }
            
            toggleMicrophone() {
                this.addMsg('SISTEMA', 'üí° El control de voz est√° desactivado temporalmente. Usa el teclado para interactuar.', 'msg-sys');
            }
            
            toggleTTS() {
                this.addMsg('SISTEMA', 'üí° El control de voz est√° desactivado temporalmente. Usa el teclado para interactuar.', 'msg-sys');
            }
        }

        // Inicializaci√≥n segura de la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Verificar compatibilidad m√≠nima
                const isCompatible = 'fetch' in window && 
                                   ('TextEncoder' in window || 'TextDecoder' in window) &&
                                   ('crypto' in window);
                
                if (!isCompatible) {
                    document.getElementById('chat-box').innerHTML = `
                        <div class="msg msg-sys" style="color:var(--red);">
                            <strong>‚ùå NAVEGADOR NO COMPATIBLE</strong><br>
                            NEXUS INFINITY requiere un navegador moderno.<br><br>
                            <span style="color:var(--yellow);">üí° Soluci√≥n:</span><br>
                            Actualiza a Chrome, Edge o Firefox √∫ltima versi√≥n
                        </div>
                    `;
                    return;
                }
                
                window.app = new NexusInfinity();
                console.log('‚úÖ NEXUS INFINITY v17.2 inicializado correctamente');
                
            } catch (e) {
                console.error('‚ùå Error fatal inicializando NEXUS:', e);
                document.getElementById('chat-box').innerHTML = `
                    <div class="msg msg-sys" style="color:var(--red);">
                        <strong>‚ùå ERROR FATAL DE INICIALIZACI√ìN</strong><br>
                        ${e.message || 'Error desconocido'}<br><br>
                        <span style="color:var(--yellow);">üí° Soluci√≥n recomendada:</span><br>
                        1. Actualiza tu navegador a Chrome/Edge √∫ltima versi√≥n<br>
                        2. Limpia la cach√© del navegador (Ctrl+Shift+R)<br>
                        3. Si el problema persiste, activa el modo nube
                    </div>
                `;
            }
        });
    </script>
</body>
</html>

