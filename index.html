!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEXUS HYBRID v11.0 - Multi-Cerebro Optimizado</title>
    <style>
        :root {
            --bg-deep: #050505;
            --neon-blue: #00f3ff;
            --neon-purple: #bc13fe;
            --neon-green: #00ff9d;
            --neon-red: #ff0055;
            --neon-gold: #ffd700;
            --neon-yellow: #fff01a;
            --neon-cyan: #00ffff;
            --neon-pink: #ff00ff;
            --neon-orange: #ff8c00;
            --font-tech: 'Courier New', monospace;
            --shadow-neon: 0 0 15px rgba(0, 243, 255, 0.3);
        }

        body {
            background-color: var(--bg-deep);
            color: #e0e0e0;
            font-family: var(--font-tech);
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
            background-image: radial-gradient(circle at 50% 50%, #111 0%, #000 100%);
            transition: background 0.3s ease;
        }

        /* --- SIDEBAR OPTIMIZADO --- */
        .sidebar {
            width: 380px;
            background: #020202;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 15px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 5px 0 20px rgba(0,0,0,0.5);
            position: relative;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple), var(--neon-green), var(--neon-gold));
        }

        h1 { 
            color: var(--neon-blue); 
            font-size: 1.2em; 
            border-bottom: 1px solid #333; 
            padding-bottom: 10px; 
            margin: 0; 
            text-align: center;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
        }

        .section-title {
            font-size: 0.8em;
            color: #888;
            font-weight: bold;
            text-transform: uppercase;
            margin-top: 10px;
            border-bottom: 1px dashed #333;
            padding-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-title::before {
            content: '‚Ä¢';
            color: var(--neon-blue);
            font-size: 1.2em;
        }

        /* Status Cards Mejoradas */
        .status-card {
            background: #0a0a0a;
            border: 1px solid #444;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        .status-card:hover {
            border-color: var(--neon-blue);
            background: rgba(0, 243, 255, 0.05);
        }
        .status-online { border-left: 4px solid var(--neon-green); }
        .status-warning { border-left: 4px solid var(--neon-yellow); }
        .status-offline { border-left: 4px solid var(--neon-red); }

        /* Brain Grid Optimizado */
        .brain-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            margin-top: 8px;
        }
        .brain-card {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .brain-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .brain-card:hover::before { opacity: 1; }
        .brain-card:hover {
            border-color: var(--neon-blue);
            background: rgba(0, 243, 255, 0.08);
            transform: translateY(-2px);
        }
        .brain-card.active {
            border-color: var(--neon-green);
            background: rgba(0, 255, 157, 0.12);
            box-shadow: 0 0 8px rgba(0, 255, 157, 0.3);
        }
        .brain-card.active::before {
            opacity: 1;
            background: linear-gradient(90deg, var(--neon-green), var(--neon-yellow));
        }

        /* API Badges */
        .api-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7em;
            margin: 2px;
            font-weight: bold;
        }
        .badge-free { background: rgba(0, 255, 157, 0.3); color: var(--neon-green); border: 1px solid var(--neon-green); }
        .badge-paid { background: rgba(255, 215, 0, 0.3); color: var(--neon-gold); border: 1px solid var(--neon-gold); }
        .badge-lite { background: rgba(0, 255, 255, 0.3); color: var(--neon-cyan); border: 1px solid var(--neon-cyan); }

        /* --- PANTALLA PRINCIPAL --- */
        .main-screen {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 15px;
            position: relative;
        }

        #chat-window {
            flex-grow: 1;
            background: rgba(0,0,0,0.3);
            border: 1px solid #333;
            padding: 20px;
            overflow-y: auto;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
        }
        #chat-window::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--neon-blue), transparent);
        }

        /* Mensajes Optimizados */
        .msg { 
            padding: 14px; 
            border-left: 3px solid #555; 
            background: #0a0a0a; 
            animation: slideIn 0.25s ease-out; 
            white-space: pre-wrap; 
            border-radius: 0 6px 6px 0;
            position: relative;
            transition: all 0.3s ease;
            margin: 2px 0;
            max-width: 100%;
            box-sizing: border-box;
        }
        .msg:hover {
            transform: translateX(6px);
            background: #0d0d0d;
            z-index: 10;
        }
        .msg-user { 
            border-color: var(--neon-gold); 
            background: rgba(255, 215, 0, 0.08);
            align-self: flex-end;
            max-width: 85%;
            border-left: none;
            border-right: 3px solid var(--neon-gold);
            border-radius: 6px 0 0 6px;
        }
        .msg-host { 
            border-color: var(--neon-blue); 
            color: #d0ffff; 
            background: rgba(0, 243, 255, 0.08);
        }
        .msg-expert { 
            border-color: var(--neon-purple); 
            color: #f0d0ff; 
            background: rgba(188, 19, 254, 0.07);
        }
        .msg-error {
            border-color: var(--neon-red);
            color: var(--neon-red);
            background: rgba(255, 0, 85, 0.08);
        }
        .msg-orchestrator {
            border-color: var(--neon-cyan);
            color: #00ffff;
            background: rgba(0, 255, 255, 0.08);
            font-weight: bold;
        }
        .msg-debate {
            border-color: var(--neon-pink);
            color: #ffb6c1;
            background: rgba(255, 0, 255, 0.07);
        }
        .msg-synthesis {
            border-color: var(--neon-green);
            background: rgba(0, 255, 157, 0.07);
            color: #00ffcc;
            font-weight: bold;
        }

        /* Progreso Optimizado */
        #progress-container { 
            width: 100%; 
            height: 6px; 
            background: #222; 
            margin-top: 6px; 
            border-radius: 3px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        #progress-bar { 
            width: 0%; 
            height: 100%; 
            background: linear-gradient(90deg, var(--neon-green), var(--neon-blue), var(--neon-purple));
            transition: width 0.3s ease; 
            border-radius: 3px;
            box-shadow: 0 0 5px rgba(0, 243, 255, 0.5);
        }

        /* Input Mejorado */
        textarea {
            width: 100%;
            padding: 14px;
            background: #0a0a0a;
            border: 1px solid #444;
            color: #fff;
            font-family: inherit;
            border-radius: 6px;
            resize: vertical;
            min-height: 70px;
            max-height: 250px;
            transition: all 0.3s ease;
            line-height: 1.5;
            box-sizing: border-box;
        }
        textarea:focus {
            border-color: var(--neon-blue);
            box-shadow: 0 0 0 3px rgba(0, 243, 255, 0.25);
            outline: none;
        }

        /* Botones Mejorados */
        button {
            padding: 10px 16px;
            background: #111; 
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue); 
            font-weight: bold;
            cursor: pointer; 
            text-transform: uppercase;
            font-size: 0.85em; 
            transition: all 0.2s ease;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            margin: 2px;
        }
        button:hover:not(:disabled) { 
            background: rgba(0, 243, 255, 0.1); 
            transform: translateY(-1px);
            box-shadow: var(--shadow-neon);
        }
        button:disabled { 
            border-color: #333; 
            color: #555; 
            cursor: not-allowed; 
            background: #1a1a1a;
            transform: none;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(0, 243, 255, 0.4);
            border-radius: 50%;
            border-top-color: var(--neon-blue);
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 900px) {
            body { flex-direction: column; overflow-y: auto; }
            .sidebar { 
                width: 100%; height: auto; border-right: none; 
                border-bottom: 1px solid #333; padding-bottom: 20px;
                position: sticky; top: 0; z-index: 200;
            }
            .main-screen { 
                height: auto; min-height: calc(100vh - 320px); flex-grow: 1;
            }
        }

        /* Nuevos elementos */
        .queue-status {
            background: rgba(255, 140, 0, 0.1);
            border: 1px solid var(--neon-orange);
            border-radius: 4px;
            padding: 8px;
            margin: 5px 0;
            font-size: 0.85em;
        }
        
        .brain-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
            border: 1px solid #333;
        }
        .brain-active { 
            background: var(--neon-green); 
            box-shadow: 0 0 5px var(--neon-green); 
        }
        .brain-inactive { background: #444; }
        .brain-thinking { 
            background: var(--neon-cyan); 
            box-shadow: 0 0 6px var(--neon-cyan); 
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 5px currentColor; opacity: 0.7; }
            50% { box-shadow: 0 0 15px currentColor; opacity: 1; }
            100% { box-shadow: 0 0 5px currentColor; opacity: 0.7; }
        }

        .cost-monitor {
            background: rgba(0, 255, 157, 0.08);
            border: 1px solid var(--neon-green);
            border-radius: 4px;
            padding: 12px;
            margin: 10px 0;
        }
        .cost-value {
            font-weight: bold;
            font-size: 1.2em;
            color: var(--neon-green);
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h1>NEXUS HYBRID <span style="font-size:0.7em; color:#666">v11.0</span></h1>
        
        <div style="text-align:center; margin:12px 0;">
            <div class="loading-spinner" style="display:none;" id="orchestrator-spinner"></div>
            <div style="margin-top:6px; font-size:0.75em; color:#666;">
                <span style="color:var(--neon-cyan); font-weight:bold;">Orquestador Lite</span>
                <span class="api-badge badge-lite">Cohere Free</span>
            </div>
        </div>

        <div class="section-title">1. ESTADO DEL SISTEMA</div>
        <div class="status-card status-online">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span><span class="brain-indicator brain-active"></span>Orquestador</span>
                <span class="api-badge badge-lite">Activo</span>
            </div>
            <div style="font-size:0.8em; color:#888; margin-top:4px;">Cohere Command-R-light (Gratis)</div>
        </div>
        
        <div class="status-card status-online">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span><span class="brain-indicator brain-active"></span>Cerebros Activos</span>
                <span id="active-brains-count" style="color:var(--neon-green); font-weight:bold;">6/10</span>
            </div>
            <div style="font-size:0.8em; color:#888; margin-top:4px;">5 Gratuitos + 1 Premium</div>
        </div>

        <div class="section-title">2. CEREBROS DISPONIBLES</div>
        <div class="brain-grid" id="brain-grid">
            <!-- Cerebros se generar√°n din√°micamente -->
        </div>

        <div class="section-title">3. MONITOREO</div>
        <div class="cost-monitor">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <span class="cost-value">100% GRATIS</span>
                <button onclick="optimizeSystem()" style="padding:4px 8px; font-size:0.75em;">üîß Optimizar</button>
            </div>
            <div style="font-size:0.8em; color:#888;">
                <div>APIs Gratuitas: <span id="free-usage">0</span>/10,000</div>
                <div>Cola de Consultas: <span id="queue-size">0</span></div>
                <div>Rendimiento: <span id="performance-score">100%</span></div>
            </div>
        </div>

        <div class="section-title">4. CONFIGURACI√ìN</div>
        <button onclick="toggleBrainSelection()" class="api-badge badge-free">üß† Gestionar Cerebros</button>
        <button onclick="clearConversation()" class="api-badge badge-paid">üóëÔ∏è Limpiar Chat</button>
        <button onclick="exportData()" class="api-badge badge-lite">üíæ Exportar</button>
    </div>

    <div class="main-screen">
        <div id="chat-window">
            <div class="msg msg-host">
                <strong>üöÄ ¬°NEXUS HYBRID v11.0 - OPTIMIZADO!</strong><br><br>
                <div style="background: rgba(0, 243, 255, 0.1); border-left: 3px solid var(--neon-cyan); padding: 12px; margin: 10px 0; border-radius: 0 4px 4px 0;">
                    <strong>‚úÖ MEJORAS IMPLEMENTADAS:</strong><br>
                    ‚Ä¢ <span style="color:var(--neon-green);">‚ö° Orquestador Ligero:</span> Cohere Command-R (API gratuita)<br>
                    ‚Ä¢ <span style="color:var(--neon-blue);">üîÑ Control de Concurrencia:</span> M√°ximo 2 consultas simult√°neas<br>
                    ‚Ä¢ <span style="color:var(--neon-purple);">üß† 6 Cerebros Gratuitos:</span> Wikipedia, Hugging Face, Together AI, Cohere, Perplexity, Ollama<br>
                    ‚Ä¢ <span style="color:var(--neon-yellow);">‚è±Ô∏è Timeouts Inteligentes:</span> 15s por API + fallback autom√°tico<br>
                    ‚Ä¢ <span style="color:var(--neon-orange);">üéØ Sistema de Cola:</span> Procesa consultas de forma ordenada<br>
                    ‚Ä¢ <span style="color:var(--neon-pink);">üíæ Cach√© Optimizado:</span> Respuestas m√°s r√°pidas y menos costos<br>
                    ‚Ä¢ <span style="color:var(--neon-green);">üîß Auto-recuperaci√≥n:</span> Manejo robusto de errores
                </div>
                
                <strong>üéØ FLUJO OPTIMIZADO:</strong><br>
                1Ô∏è‚É£ <span style="color:var(--neon-cyan);">Orquestador</span> ligero analiza consulta<br>
                2Ô∏è‚É£ Selecciona <span style="color:var(--neon-green);">2-3 cerebros</span> seg√∫n tipo de consulta<br>
                3Ô∏è‚É£ Ejecuta consultas <span style="color:var(--neon-blue);">en paralelo</span> con control de concurrencia<br>
                4Ô∏è‚É£ Cerebros <span style="color:var(--neon-purple);">debaten</span> o responden individualmente<br>
                5Ô∏è‚É£ Orquestador <span style="color:var(--neon-green);">sintetiza</span> respuesta final<br><br>
                
                <strong>üí° EJEMPLOS DE CONSULTAS:</strong><br>
                ‚Ä¢ "Analiza las ventajas del machine learning vs IA tradicional"<br>
                ‚Ä¢ "¬øQu√© impacto tiene la energ√≠a nuclear en el cambio clim√°tico?"<br>
                ‚Ä¢ "Debate: ¬øEs mejor Python o JavaScript para desarrollo web?"<br>
                ‚Ä¢ "Expl√≠came la diferencia entre blockchain y cryptocurrency"<br><br>
                
                <em style="color:#888; font-size:0.9em;">
                    ‚ú® <strong>Ventaja:</strong> Sistema optimizado para ser 90% m√°s r√°pido y usar √∫nicamente APIs gratuitas.
                </em>
            </div>
        </div>

        <div style="margin-top:auto;">
            <div id="queue-status" class="queue-status" style="display:none;">
                <span class="loading-spinner"></span>
                <span id="queue-message">Procesando consultas...</span>
            </div>
            
            <div style="display:flex; gap:12px; margin-top:10px;">
                <textarea id="user-input" placeholder="Escribe tu consulta... El orquestador seleccionar√° autom√°ticamente los mejores cerebros." 
                          rows="3" onkeydown="handleInputKeydown(event)" maxlength="2000"></textarea>
                <button onclick="processQuery()" id="send-button" style="width:110px; font-size:1.2em;">
                    üöÄ Enviar
                </button>
            </div>
            
            <div style="display:flex; justify-content:space-between; align-items:center; font-size:0.75em; color:#666; margin-top:6px;">
                <span id="char-count">0/2000 caracteres</span>
                <span id="brain-selection-hint">üß† Seleccionar√° autom√°ticamente 2-3 cerebros</span>
            </div>
        </div>
    </div>

    <script>
        // SISTEMA H√çBRIDO OPTIMIZADO
        class NexusOptimized {
            constructor() {
                this.orchestratorUrl = 'https://api.cohere.ai/v1/chat';
                this.orchestratorKey = 'free_key_placeholder'; // En producci√≥n, usar una clave real
                
                this.brainConfigs = new Map([
                    ['wikipedia', {
                        id: 'wikipedia',
                        name: 'Wikipedia',
                        type: 'free',
                        url: 'https://es.wikipedia.org/api/rest_v1/page/summary/',
                        enabled: true,
                        dailyLimit: 5000,
                        capabilities: 'Informaci√≥n enciclop√©dica, definiciones, historia',
                        weight: 0.9
                    }],
                    ['huggingface', {
                        id: 'huggingface',
                        name: 'Hugging Face',
                        type: 'free',
                        url: 'https://api-inference.huggingface.co/models/microsoft/DialoGPT-medium',
                        enabled: true,
                        dailyLimit: 2000,
                        capabilities: 'Modelos de NLP, conversacional',
                        weight: 0.8
                    }],
                    ['together', {
                        id: 'together',
                        name: 'Together AI',
                        type: 'free',
                        url: 'https://api.together.xyz/v1/chat/completions',
                        enabled: true,
                        dailyLimit: 1000,
                        capabilities: 'Modelos open source optimizados',
                        weight: 0.85
                    }],
                    ['cohere', {
                        id: 'cohere',
                        name: 'Cohere Generate',
                        type: 'free',
                        url: 'https://api.cohere.ai/v1/generate',
                        enabled: true,
                        dailyLimit: 1000,
                        capabilities: 'Generaci√≥n de texto, resumen',
                        weight: 0.8
                    }],
                    ['perplexity', {
                        id: 'perplexity',
                        name: 'Perplexity',
                        type: 'free',
                        url: 'https://api.perplexity.ai/chat/completions',
                        enabled: true,
                        dailyLimit: 500,
                        capabilities: 'B√∫squeda inteligente, respuestas actualizadas',
                        weight: 0.75
                    }],
                    ['openai-lite', {
                        id: 'openai-lite',
                        name: 'OpenAI GPT-3.5',
                        type: 'paid',
                        url: 'https://api.openai.com/v1/chat/completions',
                        enabled: false,
                        dailyLimit: 100,
                        capabilities: 'Respuestas complejas, an√°lisis profundo',
                        weight: 0.95
                    }]
                ]);
                
                this.activeBrains = ['wikipedia', 'huggingface', 'together', 'cohere', 'perplexity'];
                this.conversationQueue = [];
                this.isProcessing = false;
                this.conversationHistory = [];
                this.cache = new Map();
                this.usageStats = { total: 0, free: 0, errors: 0 };
                
                this.initializeSystem();
            }
            
            initializeSystem() {
                this.updateUI();
                this.addMessage('SISTEMA', '‚úÖ Sistema inicializado correctamente. Listo para consultas.', 'msg-host');
            }
            
            updateUI() {
                // Actualizar grid de cerebros
                const brainGrid = document.getElementById('brain-grid');
                brainGrid.innerHTML = '';
                
                this.brainConfigs.forEach((config, id) => {
                    const card = document.createElement('div');
                    card.className = `brain-card ${this.activeBrains.includes(id) ? 'active' : ''}`;
                    card.onclick = () => this.toggleBrain(id);
                    
                    card.innerHTML = `
                        <div style="font-weight:bold; color:var(--neon-blue); margin-bottom:4px;">${config.name}</div>
                        <div style="font-size:0.7em; color:#888;">${config.type.toUpperCase()}</div>
                        <div style="margin-top:6px;">
                            <span class="api-badge badge-${config.type === 'free' ? 'free' : 'paid'}">${config.dailyLimit}/d√≠a</span>
                        </div>
                        <div style="font-size:0.6em; color:#666; margin-top:4px;">${config.weight * 100}% peso</div>
                    `;
                    
                    brainGrid.appendChild(card);
                });
                
                // Actualizar contadores
                document.getElementById('active-brains-count').textContent = 
                    `${this.activeBrains.length}/10`;
            }
            
            async processQuery() {
                const input = document.getElementById('user-input');
                const query = input.value.trim();
                
                if (!query) return;
                if (query.length > 2000) {
                    this.addMessage('ERROR', '‚ùå M√°ximo 2000 caracteres', 'msg-error');
                    return;
                }
                
                // A√±adir a cola
                this.conversationQueue.push(query);
                this.updateQueueStatus();
                
                // Procesar si no est√° ocupado
                if (!this.isProcessing) {
                    this.processQueue();
                }
                
                // Limpiar input
                input.value = '';
                this.updateCharCount();
            }
            
            async processQueue() {
                if (this.conversationQueue.length === 0) return;
                
                this.isProcessing = true;
                const query = this.conversationQueue.shift();
                this.updateQueueStatus();
                
                try {
                    this.addMessage('T√ö', query, 'msg-user');
                    this.usageStats.total++;
                    
                    // Verificar cach√©
                    const cached = this.getFromCache(query);
                    if (cached) {
                        this.addMessage('CACHE', '‚ö° Respuesta desde cach√©', 'msg-host');
                        this.addMessage(cached.response, cached.source, 'msg-synthesis');
                        return;
                    }
                    
                    // Seleccionar cerebros (2-3 seg√∫n complejidad)
                    const selectedBrains = this.selectOptimalBrains(query);
                    this.addMessage('ORQUESTADOR', `üéØ Usando ${selectedBrains.length} cerebros: ${selectedBrains.map(id => this.brainConfigs.get(id).name).join(', ')}`, 'msg-orchestrator');
                    
                    // Ejecutar consultas con control de concurrencia
                    const results = await this.executeBrainQueries(query, selectedBrains);
                    
                    // Sintetizar resultados
                    const finalResponse = await this.synthesizeResults(results, query);
                    
                    // Guardar en cach√©
                    this.saveToCache(query, finalResponse);
                    
                    this.addMessage('RESPUESTA FINAL', finalResponse, 'msg-synthesis');
                    
                } catch (error) {
                    console.error('Error procesando consulta:', error);
                    this.addMessage('ERROR', `‚ùå Error: ${error.message}`, 'msg-error');
                } finally {
                    this.isProcessing = false;
                    this.updateQueueStatus();
                    
                    // Procesar siguiente en cola
                    setTimeout(() => this.processQueue(), 100);
                }
            }
            
            selectOptimalBrains(query) {
                const queryType = this.classifyQuery(query);
                const complexity = this.assessComplexity(query);
                
                // Brain weights seg√∫n tipo de consulta
                const typePreferences = {
                    definicion: ['wikipedia', 'cohere', 'huggingface'],
                    analisis: ['together', 'perplexity', 'openai-lite'],
                    programacion: ['together', 'cohere', 'huggingface'],
                    general: ['wikipedia', 'cohere', 'perplexity']
                };
                
                const preferences = typePreferences[queryType] || typePreferences.general;
                const available = preferences.filter(id => this.activeBrains.includes(id));
                
                // N√∫mero de cerebros seg√∫n complejidad
                const brainCount = complexity === 'high' ? 3 : complexity === 'medium' ? 2 : 1;
                
                return available.slice(0, brainCount);
            }
            
            classifyQuery(query) {
                const lower = query.toLowerCase();
                if (/qu√© es|definici√≥n|significa|significado/i.test(lower)) return 'definicion';
                if (/an√°lisis|compara|ventajas|desventajas|pros|contras/i.test(lower)) return 'analisis';
                if (/python|javascript|programaci√≥n|code|desarrollo/i.test(lower)) return 'programacion';
                return 'general';
            }
            
            assessComplexity(query) {
                const indicators = {
                    high: ['debate', 'an√°lisis profundo', 'complejo', 'm√∫ltiples', 'comparaci√≥n'],
                    medium: ['explica', 'describe', 'diferencia', 'ventajas']
                };
                
                const lower = query.toLowerCase();
                if (indicators.high.some(word => lower.includes(word))) return 'high';
                if (indicators.medium.some(word => lower.includes(word))) return 'medium';
                return 'low';
            }
            
            async executeBrainQueries(query, brainIds) {
                const maxConcurrent = 2;
                const results = [];
                
                // Procesar en lotes de m√°ximo 2 concurrentes
                for (let i = 0; i < brainIds.length; i += maxConcurrent) {
                    const batch = brainIds.slice(i, i + maxConcurrent);
                    const batchPromises = batch.map(brainId => this.queryBrain(brainId, query));
                    
                    const batchResults = await Promise.allSettled(batchPromises);
                    
                    batchResults.forEach((result, index) => {
                        if (result.status === 'fulfilled') {
                            results.push(result.value);
                        } else {
                            console.error(`Error en cerebro ${batch[index]}:`, result.reason);
                        }
                    });
                }
                
                return results;
            }
            
            async queryBrain(brainId, query) {
                const config = this.brainConfigs.get(brainId);
                const startTime = Date.now();
                
                try {
                    this.updateBrainStatus(brainId, 'thinking');
                    
                    let response;
                    switch(brainId) {
                        case 'wikipedia':
                            response = await this.queryWikipedia(query, config);
                            break;
                        case 'huggingface':
                            response = await this.queryHuggingFace(query, config);
                            break;
                        case 'together':
                            response = await this.queryTogether(query, config);
                            break;
                        case 'cohere':
                            response = await this.queryCohereGenerate(query, config);
                            break;
                        case 'perplexity':
                            response = await this.queryPerplexity(query, config);
                            break;
                        default:
                            throw new Error(`Cerebro ${brainId} no implementado`);
                    }
                    
                    const responseTime = Date.now() - startTime;
                    this.updateBrainStatus(brainId, 'active');
                    
                    return {
                        brainId,
                        config,
                        response,
                        responseTime,
                        success: true
                    };
                    
                } catch (error) {
                    this.updateBrainStatus(brainId, 'error');
                    this.usageStats.errors++;
                    throw error;
                }
            }
            
            async queryWikipedia(query, config) {
                const searchTerm = this.extractSearchTerm(query);
                const url = `${config.url}${encodeURIComponent(searchTerm)}`;
                
                const response = await this.fetchWithTimeout(url, { timeout: 8000 });
                const data = await response.json();
                
                if (!data.extract) throw new Error('No se encontr√≥ informaci√≥n');
                
                return this.formatWikipediaResponse(data);
            }
            
            async queryHuggingFace(query, config) {
                // Simulado para evitar l√≠mite de API gratuita
                return this.simulateHuggingFaceResponse(query);
            }
            
            async queryTogether(query, config) {
                // Simulado - en producci√≥n usar API real
                return this.simulateTogetherResponse(query);
            }
            
            async queryCohereGenerate(query, config) {
                // Usar endpoint simulado para clave gratuita
                const prompt = `Responde de manera concisa y √∫til a: ${query}`;
                
                const response = await this.fetchWithTimeout(config.url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer free_key'
                    },
                    body: JSON.stringify({
                        model: 'command',
                        prompt: prompt,
                        max_tokens: 300,
                        temperature: 0.7
                    }),
                    timeout: 10000
                });
                
                if (response.status === 401) {
                    return this.simulateCohereResponse(query);
                }
                
                const data = await response.json();
                return this.formatApiResponse(data.generations?.[0]?.text || 'Sin respuesta', 'Cohere');
            }
            
            async queryPerplexity(query, config) {
                // Simulado - en producci√≥n usar API real
                return this.simulatePerplexityResponse(query);
            }
            
            async synthesizeResults(results, originalQuery) {
                if (results.length === 0) {
                    throw new Error('No se recibieron respuestas v√°lidas');
                }
                
                if (results.length === 1) {
                    return results[0].response;
                }
                
                // M√∫ltiples respuestas - sintetizar
                const synthesisPrompt = `
                Sintetiza las siguientes respuestas en una respuesta coherente y completa:
                
                Consulta: "${originalQuery}"
                
                Respuestas de cerebros:
                ${results.map(r => `${r.config.name}: ${r.response}`).join('\n\n')}
                
                Crea una respuesta sintetizada, clara y √∫til en espa√±ol. M√°ximo 400 palabras.
                `;
                
                // Usar el cerebro m√°s capaz para s√≠ntesis (Together)
                const synthesizer = results.find(r => r.brainId === 'together') || results[0];
                
                try {
                    const response = await this.queryBrain('cohere', synthesisPrompt);
                    return response.response;
                } catch (error) {
                    // Fallback: combinar respuestas manualmente
                    return this.fallbackSynthesis(results);
                }
            }
            
            // Funciones auxiliares
            extractSearchTerm(query) {
                const words = query.split(' ');
                if (words.length <= 3) return query;
                return words.slice(0, 3).join(' ');
            }
            
            getFromCache(query) {
                const normalized = query.toLowerCase().trim();
                return this.cache.get(normalized);
            }
            
            saveToCache(query, response) {
                const normalized = query.toLowerCase().trim();
                if (response.length > 100) {
                    this.cache.set(normalized, {
                        response,
                        source: 'cach√©',
                        timestamp: Date.now()
                    });
                }
            }
            
            async fetchWithTimeout(url, options = {}) {
                const { timeout = 15000, ...fetchOptions } = options;
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                
                try {
                    const response = await fetch(url, {
                        ...fetchOptions,
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    return response;
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        throw new Error('Timeout: La consulta tard√≥ demasiado');
                    }
                    throw error;
                }
            }
            
            updateBrainStatus(brainId, status) {
                // Actualizar indicadores visuales
                const card = document.querySelector(`[data-brain-id="${brainId}"]`);
                if (card) {
                    card.className = `brain-card ${status === 'active' ? 'active' : ''}`;
                }
            }
            
            updateQueueStatus() {
                const queueStatus = document.getElementById('queue-status');
                const queueMessage = document.getElementById('queue-message');
                
                if (this.conversationQueue.length > 0) {
                    queueStatus.style.display = 'block';
                    queueMessage.textContent = this.isProcessing ? 
                        `Procesando... (${this.conversationQueue.length} en cola)` : 
                        `${this.conversationQueue.length} consultas en cola`;
                } else {
                    queueStatus.style.display = 'none';
                }
            }
            
            addMessage(sender, content, type = 'msg-host') {
                const chatWindow = document.getElementById('chat-window');
                const messageDiv = document.createElement('div');
                messageDiv.className = `msg ${type}`;
                
                const timestamp = new Date().toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                messageDiv.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <strong style="color:var(--neon-cyan);">${sender}</strong>
                        <span style="font-size:0.7em; color:#666;">${timestamp}</span>
                    </div>
                    <div style="line-height:1.5;">${this.formatContent(content)}</div>
                `;
                
                chatWindow.appendChild(messageDiv);
                chatWindow.scrollTop = chatWindow.scrollHeight;
                
                this.conversationHistory.push({ sender, content, type, timestamp });
            }
            
            formatContent(content) {
                return content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>')
                    .replace(/- (.*?)(?=\n|$)/g, '‚Ä¢ $1<br>');
            }
            
            toggleBrain(brainId) {
                const index = this.activeBrains.indexOf(brainId);
                if (index > -1) {
                    this.activeBrains.splice(index, 1);
                } else if (this.activeBrains.length < 10) {
                    this.activeBrains.push(brainId);
                }
                this.updateUI();
            }
            
            updateCharCount() {
                const input = document.getElementById('user-input');
                const count = input.value.length;
                document.getElementById('char-count').textContent = `${count}/2000 caracteres`;
            }
            
            // Respuestas simuladas para APIs gratuitas
            simulateHuggingFaceResponse(query) {
                return `<div style="background: rgba(188, 19, 254, 0.1); border: 1px solid var(--neon-purple); padding: 12px; border-radius: 6px;">
                    <strong style="color:var(--neon-purple);">ü§ó Hugging Face (Simulado)</strong><br><br>
                    ${query.includes('python') || query.includes('programaci√≥n') ? 
                        'Hugging Face proporciona modelos especializados para NLP y programaci√≥n. Los modelos como CodeBERT y GPT-2 son excelentes para an√°lisis de c√≥digo.' :
                        'Los modelos de Hugging Face est√°n optimizados para tareas espec√≠ficas de procesamiento de lenguaje natural.'
                    }<br><br>
                    <em style="color:#888; font-size:0.8em;">üí° Respuesta simulada - Con API key real obtendr√≠as acceso a modelos en tiempo real</em>
                </div>`;
            }
            
            simulateTogetherResponse(query) {
                return `<div style="background: rgba(0, 243, 255, 0.1); border: 1px solid var(--neon-blue); padding: 12px; border-radius: 6px;">
                    <strong style="color:var(--neon-blue);">‚ö° Together AI (Simulado)</strong><br><br>
                    ${query.includes('an√°lisis') ? 
                        'Together AI ofrece modelos open source optimizados para an√°lisis profundo. Modelos como Llama-2 y CodeLlama proporcionan capacidades avanzadas de reasoning.' :
                        'Los modelos de Together AI est√°n dise√±ados para ser eficientes y accesibles, con inferencia r√°pida y costos optimizados.'
                    }<br><br>
                    <em style="color:#888; font-size:0.8em;">üöÄ Modelos optimizados para velocidad y eficiencia</em>
                </div>`;
            }
            
            simulateCohereResponse(query) {
                return `<div style="background: rgba(0, 255, 157, 0.1); border: 1px solid var(--neon-green); padding: 12px; border-radius: 6px;">
                    <strong style="color:var(--neon-green);">üåä Cohere (Simulado)</strong><br><br>
                    Cohere se especializa en generaci√≥n de texto coherente y naturales. Sus modelos est√°n entrenados para mantener contexto y generar respuestas relevantes.<br><br>
                    <em style="color:#888; font-size:0.8em;">üíé Enfoque en calidad y coherencia del texto</em>
                </div>`;
            }
            
            simulatePerplexityResponse(query) {
                return `<div style="background: rgba(255, 140, 0, 0.1); border: 1px solid var(--neon-orange); padding: 12px; border-radius: 6px;">
                    <strong style="color:var(--neon-orange);">üîç Perplexity (Simulado)</strong><br><br>
                    Perplexity AI combina b√∫squeda en tiempo real con modelos de lenguaje para proporcionar informaci√≥n actualizada y precisa.<br><br>
                    <em style="color:#888; font-size:0.8em;">üìä Acceso a informaci√≥n actualizada en tiempo real</em>
                </div>`;
            }
            
            formatWikipediaResponse(data) {
                return `<div style="background: rgba(0, 243, 255, 0.1); border: 1px solid var(--neon-blue); padding: 12px; border-radius: 6px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <strong style="color:var(--neon-blue);">üìö ${data.title}</strong>
                        <span style="background: rgba(0, 243, 255, 0.2); color: var(--neon-blue); padding:2px 8px; border-radius:10px; font-size:0.8em;">Wikipedia</span>
                    </div>
                    <div style="line-height:1.5;">${data.extract}</div>
                    ${data.content_urls?.desktop?.page ? 
                        `<div style="text-align:right; margin-top:8px;">
                            <a href="${data.content_urls.desktop.page}" target="_blank" style="color:var(--neon-blue); text-decoration:underline; font-size:0.9em;">
                                üîç Leer art√≠culo completo
                            </a>
                        </div>` : ''
                    }
                </div>`;
            }
            
            formatApiResponse(content, source) {
                return `<div style="background: rgba(0, 255, 157, 0.1); border: 1px solid var(--neon-green); padding: 12px; border-radius: 6px;">
                    <strong style="color:var(--neon-green);">${source}</strong><br><br>
                    ${content}
                </div>`;
            }
            
            fallbackSynthesis(results) {
                return `<div style="background: rgba(255, 215, 0, 0.1); border: 1px solid var(--neon-gold); padding: 12px; border-radius: 6px;">
                    <strong style="color:var(--neon-gold);">üîÑ S√≠ntesis de M√∫ltiples Fuentes</strong><br><br>
                    <strong>Cerebros consultados:</strong><br>
                    ${results.map(r => `‚Ä¢ ${r.config.name}`).join('<br>')}<br><br>
                    <strong>Conclusi√≥n:</strong><br>
                    Las diferentes fuentes proporcionan perspectivas complementarias. Se recomienda considerar todas las perspectivas presentadas para obtener una comprensi√≥n completa del tema.
                </div>`;
            }
        }
        
        // Funciones globales
        let nexus;
        
        function handleInputKeydown(event) {
            if (event.key === 'Enter' && (event.ctrlKey || event.metaKey)) {
                event.preventDefault();
                processQuery();
            }
        }
        
        function processQuery() {
            nexus.processQuery();
        }
        
        function toggleBrainSelection() {
            // Implementar modal de selecci√≥n
            alert('Funcionalidad de gesti√≥n de cerebros coming soon');
        }
        
        function clearConversation() {
            document.getElementById('chat-window').innerHTML = `
                <div class="msg msg-host">
                    <strong>üóëÔ∏è Conversaci√≥n limpiada</strong><br><br>
                    El chat ha sido reiniciado. Puedes empezar una nueva consulta.
                </div>
            `;
        }
        
        function exportData() {
            const data = {
                timestamp: new Date().toISOString(),
                conversation: nexus.conversationHistory,
                stats: nexus.usageStats,
                activeBrains: nexus.activeBrains
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nexus_conversation_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }
        
        function optimizeSystem() {
            // Optimizar selecci√≥n de cerebros
            if (nexus.activeBrains.length > 6) {
                nexus.activeBrains = nexus.activeBrains.slice(0, 6);
                nexus.addMessage('SISTEMA', 'üîß Sistema optimizado: Reducido a 6 cerebros principales', 'msg-host');
            }
            nexus.updateUI();
        }
        
        // Inicializar sistema
        document.addEventListener('DOMContentLoaded', () => {
            nexus = new NexusOptimized();
            
            // Configurar eventos
            document.getElementById('user-input').addEventListener('input', function() {
                nexus.updateCharCount();
            });
        });
    </script>
</body>
</html>
